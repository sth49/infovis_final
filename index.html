<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
    <script src="components/scatterplot.js"></script>
    <script src="components/histogram.js"></script>
    <script src="components/datatable.js"></script>
    <script src="components/dataloader.js"></script>
    <script src="components/lineChart.js"></script>

    <title>BOHB Experiment Result</title>
    <style>
      body {
        background: #eee;
        overflow-y: scroll;
      }

      .container {
        width: 1500px;
        background: white;
        overflow-x:auto;
      }

      /* In the <style> tag in index.html */
      .brushed {
        stroke-width: 1;
        stroke: gray;
        r: 5;
      }
    </style>
  </head>

  <body>
    <header>
      <nav class="container navbar navbar-light bg-light">
        <div class="container-fluid">
          <span class="navbar-brand mb-0 h1">BOHB Experiment</span>
        </div>
      </nav>
    </header>
    <main class="container pb-3">
          </div>
        </div>
      </div>
      <div class="text-center">
        <svg width="400" height="400" id="linechart"></svg>
        <svg width="400" height="400" id="scatterplot"></svg>
        <!-- <svg width="400" height="400" id="histogram"></svg> -->
      </div>
      <table class="table table-striped text-center" style="overflow-x:auto;">
        <thead>
          <tr>
            <th>Sample Id</th>
            <th>Budget</th>
            <th>Sample type</th>
            <th>Batch size</th>
            <th>Optimizer</th>
            <th>Momentum</th>
            <th>Hidden size</th>
            <th>Scehduler</th>
            <th>Learning rate</th>
            <th>Activation</th>
            <th>Weight Decay</th>
            <th>Loss</th>
            <th>Accuracy</th>
          </tr>
        </thead>
        <tbody id="data-table"></tbody>
      </table>
    </main>

    <script>
      let data, scatterplot, histogram, dataTable;
      let linechart;
      let selected = null;
      let brushedData = null;

      function updateScatterplot() {
        // let useColor = d3.select("#use-color").property("checked");
        scatterplot.update(
          selected === null ? data.data : data.brackets[selected]
        );
      }
      function updateLineChart() {
        linechart.update();
      }

      // function updateHistogram() {
      //   histogram.update(
      //     brushedData && brushedData.length > 0 ? brushedData : data,
      //     "variety"
      //   );
      // }

      function updateDataTable(updateType = "all") {
        console.log("updateDataTable", selected);
        console.log(data.bracket)
        console.log(data.brackets[selected]);
        let data2;
        if (updateType === "all") {
          data2 = data.data;
        }
        if (updateType === "brush") {
          data2 = brushedData && brushedData.length > 0 ? brushedData : selected === null ? data.data : data.brackets[selected];
        }
        if (updateType === "linechart") {
          data2 = data.brackets[selected]? data.brackets[selected] : data.data;
        }
        dataTable.update(data2);
      }

      d3.csv(
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBFaIz7UtP909w7G_3q39Sf4qt0jA43ITVpq5k4fj6XXcMb33iVsNBmtCcZKFR0tlkNTAmj-PxYvIW/pub?gid=1850991007&single=true&output=csv"
      ).then((csvData) => {
        csvData.forEach((d) => {
          d["id"] = d["bracket"] + "-" + d["round"] + "-" + d["trial"];
          d["bracket"] = +d["bracket"];
          d["round"] = +d["round"];
          d["trial"] = +d["trial"];
          d["budget"] = +d["budget"];
          d["config_batch_size"] = +d["config_batch_size"];
          d["config_momentum"] = +d["config_momentum"];
          d["config_hidden_size"] = +d["config_hidden_size"];
          d["config_lerning_rate"] = +d["config_lerning_rate"];
          d["config_weight_decay"] = +d["config_weight_decay"];
          d["sample_loss"] = +d["sample_loss"];
          d["sample_acc"] = +d["sample_acc"];
        });
        data = new DataLoader(csvData);

        // console.log(data.bracket_0);
        scatterplot = new Scatterplot("#scatterplot");
        scatterplot.initialize();

        linechart = new LineChart("#linechart", data);
        linechart.initialize();
        updateLineChart();
        linechart.on("clicked", (dtype) => {
          selected = dtype;
          updateDataTable("linechart");
          updateScatterplot();
        });

        updateScatterplot();
        scatterplot.on("brush", (brushedItems) => {
          console.log("binding");
          console.log(brushedItems);
          brushedData = brushedItems;
          // brushedData = brushedItems;
          // updateHistogram();
          updateDataTable("brush");
        });

        // scatterplot.on("brushed", (d) => {
        //   console.log("brushed");
        //   brushedData = d ? d : null;
        //   // updateHistogram();
        //   updateDataTable();
        // });
        d3.selectAll("input[type=radio][name=x-encoding]").on(
          "change",
          updateScatterplot
        );
        d3.selectAll("input[type=radio][name=y-encoding]").on(
          "change",
          updateScatterplot
        );
        d3.selectAll("#use-color").on("change", updateScatterplot);

        dataTable = new DataTable("#data-table", data.data.columns);

        updateDataTable();
      });
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
